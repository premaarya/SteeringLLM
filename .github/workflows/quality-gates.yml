name: Quality Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to validate'
        required: true
        type: string

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  quality-checks:
    name: Enforce Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Environment
        run: |
          echo "ISSUE_NUMBER=${{ github.event.pull_request.number || github.event.inputs.issue_number }}" >> $GITHUB_ENV
      
      - name: Check Secrets in Code
        run: |
          echo "üîç Scanning for hardcoded secrets..."
          if git diff HEAD~1..HEAD | grep -iE '(password|api[_-]?key|secret|token|private[_-]?key)\s*=\s*["\047]'; then
            echo "‚ùå BLOCKED: Potential secrets detected in commit"
            echo "Detected patterns:"
            git diff HEAD~1..HEAD | grep -iE '(password|api[_-]?key|secret|token|private[_-]?key)\s*=\s*["\047]' || true
            exit 1
          fi
          echo "‚úÖ No secrets detected"
      
      - name: Validate Commit Messages
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Validating commit messages..."
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")
          
          # Check for issue reference
          if ! echo "$COMMITS" | grep -qE '#[0-9]+'; then
            echo "‚ùå BLOCKED: No issue reference (#123) found in commit messages"
            echo "Commits must reference an issue number"
            exit 1
          fi
          
          # Check for conventional commit format
          if ! echo "$COMMITS" | grep -qE '^(feat|fix|docs|test|refactor|perf|chore):'; then
            echo "‚ö†Ô∏è WARNING: Commits should follow conventional commit format (feat:, fix:, etc.)"
          fi
          
          echo "‚úÖ Commit message validation passed"
      
      - name: Check Documentation
        run: |
          echo "üîç Checking documentation..."
          
          # Check for C# XML docs
          if find . -name "*.cs" -not -path "*/obj/*" -not -path "*/bin/*" | head -1 | grep -q "."; then
            UNDOCUMENTED=$(find . -name "*.cs" -not -path "*/obj/*" -not -path "*/bin/*" -exec grep -l "public " {} \; | \
                          xargs grep -L "///" | wc -l)
            if [ "$UNDOCUMENTED" -gt 0 ]; then
              echo "‚ö†Ô∏è WARNING: $UNDOCUMENTED C# files with public APIs missing XML docs"
              echo "All public APIs should have XML documentation"
            fi
          fi
          
          # Check for README updates (if new feature)
          if [ "${{ github.event.pull_request.title }}" ]; then
            if echo "${{ github.event.pull_request.title }}" | grep -qi "feat:"; then
              if ! git diff origin/${{ github.base_ref }}..HEAD --name-only | grep -q "README.md"; then
                echo "‚ÑπÔ∏è INFO: New feature added. Consider updating README.md"
              fi
            fi
          fi
          
          echo "‚úÖ Documentation check complete"
      
      - name: Validate File Structure
        run: |
          echo "üîç Validating file structure..."
          
          # Check for proper docs structure
          if [ -d "docs" ]; then
            for dir in prd adr specs reviews ux; do
              if [ ! -d "docs/$dir" ]; then
                echo "‚ö†Ô∏è WARNING: docs/$dir/ directory not found"
              fi
            done
          fi
          
          echo "‚úÖ File structure validation complete"
      
      - name: Agent Deliverable Validation
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: |
          echo "üîç Validating agent deliverables..."
          
          # Extract issue number from PR title or branch
          ISSUE_NUM=$(echo "${{ github.event.pull_request.title }}" | grep -oP '#\K\d+' | head -1)
          
          if [ -z "$ISSUE_NUM" ]; then
            echo "‚ÑπÔ∏è No issue number found in PR title, skipping agent validation"
            exit 0
          fi
          
          # Detect agent role from PR labels or files changed
          if [ -f ".github/scripts/validate-handoff.sh" ]; then
            echo "‚ÑπÔ∏è Found validation script, checking deliverables for issue #${ISSUE_NUM}"
            # Note: Would need to detect role from PR context
            # For now, just check if validation script exists
            echo "‚úÖ Validation script available"
          fi
      
      - name: Post Quality Report
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            const report = `
            ## üîç Quality Gate Report
            
            | Check | Status |
            |-------|--------|
            | Secret Detection | ${status} |
            | Commit Message Format | ${status} |
            | Documentation | ${status} |
            | File Structure | ${status} |
            
            ${status === '‚úÖ' ? '‚úÖ All quality gates passed!' : '‚ùå Quality gates failed. Please fix the issues above.'}
            
            ---
            *AgentX Quality Gates* | [View Workflow](../../.github/workflows/quality-gates.yml)
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
